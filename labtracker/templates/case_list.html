{% extends "base.html" %}
{% block title %}케이스 관리{% endblock %}
{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1">
{% endblock %}
{% block content %}
<h1>케이스 상태 일괄 변경</h1>
<div class="mb-3">
  <label class="me-2">새 상태:
    <select id="statusSelect" class="form-select form-select-sm d-inline w-auto">
      <option value="스캔->디자인">스캔→디자인</option>
      <option value="디자인->밀링">디자인→밀링</option>
      <option value="밀링->신터링&글레이징">밀링→신터링&글레이징</option>
      <option value="기공완료">기공완료</option>
    </select>
  </label>
  <button id="bulkUpdateBtn" class="btn btn-sm btn-primary ms-2">변경</button>
</div>
<table id="caseTable" class="table table-sm">
  <thead>
    <tr>
      <th><input type="checkbox" id="checkAll"></th>
      <th>ID</th>
      <th>Status</th>
      <th>Updated At</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
const API_BASE = '/api';
async function fetchCases() {
  const res = await fetch(`${API_BASE}/cases`);
  const data = await res.json();
  const tbody = document.querySelector('#caseTable tbody');
  tbody.innerHTML = '';
  data.forEach(c => {
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td><input type="checkbox" value="${c.id}"></td>
        <td>${c.id}</td>
        <td>${c.status_label ?? c.status}</td>
        <td>${c.updated_at ?? ''}</td>
      </tr>
    `);
  });
}
document.getElementById('checkAll').addEventListener('change', e => {
  document.querySelectorAll('#caseTable tbody input[type=checkbox]')
    .forEach(cb => (cb.checked = e.target.checked));
});
document.getElementById('bulkUpdateBtn').addEventListener('click', async () => {
  const ids = Array.from(
      document.querySelectorAll('#caseTable tbody input:checked')
    ).map(cb => Number(cb.value));
  if (!ids.length) { alert('선택된 케이스가 없습니다'); return; }
  const newStatus = document.getElementById('statusSelect').value;
  const res = await fetch(`${API_BASE}/cases/bulk`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ids, new_status: newStatus })
  });
  const result = await res.json();
  alert(`변경 성공: ${result.updated}개`);
  fetchCases();
});
fetchCases();
</script>
{% endblock %}

